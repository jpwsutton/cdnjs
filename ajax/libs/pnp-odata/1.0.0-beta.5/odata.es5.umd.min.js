!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@pnp/common"),require("tslib"),require("@pnp/logging")):"function"==typeof define&&define.amd?define(["exports","@pnp/common","tslib","@pnp/logging"],t):t((e.pnp=e.pnp||{},e.pnp.odata={}),e.common,e.tslib_1,e.logging)}(this,function(e,t,n,r){"use strict";function o(e){return r.Logger.log({data:e.result,level:0,message:"["+e.requestId+"] ("+(new Date).getTime()+") Returning result, see data property for value."}),Promise.resolve(e.result||null)}function i(e,t){return new Promise(function(n){e.result=t,e.hasResult=!0,n(e)})}function u(e){var t=e.pipeline.shift();return void 0!==t?t(e):Promise.resolve(e)}function s(e){return u(e).then(function(e){return o(e)}).catch(function(e){throw r.Logger.log({data:e,level:3,message:"Error in request pipeline: "+e.message}),e})}function a(e){return void 0===e&&(e=!1),function(t,n,o){var i=o.value;o.value=function(){for(var o=[],s=0;s<arguments.length;s++)o[s]=arguments[s];return!e&&o.length>0&&o[0].hasOwnProperty("hasResult")&&o[0].hasResult?(r.Logger.write("["+o[0].requestId+"] ("+(new Date).getTime()+") Skipping request pipeline method "+n+", existing result in pipeline.",0),Promise.resolve(o[0])):(r.Logger.write("["+o[0].requestId+"] ("+(new Date).getTime()+") Calling request pipeline method "+n+".",0),i.apply(t,o).then(function(e){return u(e)}))}}}var c=function(){function e(e){this.key=e,this.expiration=t.Util.dateAdd(new Date,"second",t.RuntimeConfig.defaultCachingTimeoutSeconds),this.storeName=t.RuntimeConfig.defaultCachingStore}return Object.defineProperty(e.prototype,"store",{get:function(){return"local"===this.storeName?e.storage.local:e.storage.session},enumerable:!0,configurable:!0}),e.storage=new t.PnPClientStorage,e}(),l=function(){function e(e,t){this._parser=e,this._cacheOptions=t}return e.prototype.parse=function(e){var t=this;return this._parser.parse(e).then(function(e){return null!==t._cacheOptions.store&&t._cacheOptions.store.put(t._cacheOptions.key,e,t._cacheOptions.expiration),e})},e}(),p=function(e){function t(t,n,o){var i=e.call(this,"Error making HttpClient request in queryable: ["+t+"] "+n)||this;return i.status=t,i.statusText=n,i.data=o,i.name="ProcessHttpClientResponseException",r.Logger.log({data:i.data,level:3,message:i.message}),i}return n.__extends(t,e),t}(Error),h=function(){function e(){}return e.prototype.parse=function(e){var t=this;return new Promise(function(n,r){t.handleError(e,r)&&(e.headers.has("Content-Length")&&0===parseFloat(e.headers.get("Content-Length")||"-1")||204===e.status?n({}):e.text().then(function(e){return e.replace(/\s/gi,"").length>0?JSON.parse(e):{}}).then(function(e){return n(t.parseODataJSON(e))}).catch(function(e){return r(e)}))})},e.prototype.handleError=function(e,t){return e.ok||e.json().then(function(n){var r={responseBody:n,responseHeaders:e.headers};t(new p(e.status,e.statusText,r))}).catch(function(n){r.Logger.log({data:n,level:2,message:"There was an error parsing the error response body. See data for details."});var o={responseBody:"[[body not available]]",responseHeaders:e.headers};t(new p(e.status,e.statusText,o))}),e.ok},e.prototype.parseODataJSON=function(e){var t=e;return e.hasOwnProperty("d")?t=e.d.hasOwnProperty("results")?e.d.results:e.d:e.hasOwnProperty("value")&&(t=e.value),t},e}(),f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(t,e),t}(h),d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n.__extends(t,e),t.prototype.parse=function(t){return e.prototype.parse.call(this,t).then(function(e){return e})},t}(h),g=function(){function e(){}return e.prototype.parse=function(e){return e.json()},e}(),y=new g,b=function(){function e(){}return e.prototype.parse=function(e){return e.text()},e}(),m=function(){function e(){}return e.prototype.parse=function(e){return e.blob()},e}(),v=function(){function e(){}return e.prototype.parse=function(e){return e.json()},e}(),_=function(){function e(){}return e.prototype.parse=function(e){return t.Util.isFunction(e.arrayBuffer)?e.arrayBuffer():e.buffer()},e}(),w=function(){function e(){}return e.logStart=function(e){return new Promise(function(t){r.Logger.log({data:1===r.Logger.activeLogLevel?{}:e,level:1,message:"["+e.requestId+"] ("+(new Date).getTime()+") Beginning "+e.verb+" request ("+e.requestAbsoluteUrl+")"}),t(e)})},e.caching=function(e){return new Promise(function(n){if("GET"===e.verb&&e.isCached){r.Logger.write("["+e.requestId+"] ("+(new Date).getTime()+") Caching is enabled for request, checking cache...",1);var o=new c(e.requestAbsoluteUrl.toLowerCase());if(void 0!==e.cachingOptions&&(o=t.Util.extend(o,e.cachingOptions)),null!==o.store){var u=o.store.get(o.key);if(null!==u)return r.Logger.log({data:1===r.Logger.activeLogLevel?{}:u,level:1,message:"["+e.requestId+"] ("+(new Date).getTime()+") Value returned from cache."}),e.batchDependency(),e.parser.hasOwnProperty("hydrate")&&(u=e.parser.hydrate(u)),i(e,u).then(function(e){return n(e)})}r.Logger.write("["+e.requestId+"] ("+(new Date).getTime()+") Value not found in cache.",1),e.parser=new l(e.parser,o)}return n(e)})},e.send=function(e){return new Promise(function(n,o){if(e.isBatched){var u=e.batch.add(e.requestAbsoluteUrl,e.verb,e.options,e.parser);e.batchDependency(),r.Logger.write("["+e.requestId+"] ("+(new Date).getTime()+") Batching request in batch "+e.batch.batchId+".",1),n(i(e,u))}else{r.Logger.write("["+e.requestId+"] ("+(new Date).getTime()+") Sending request.",1);var s=e.clientFactory(),a=t.Util.extend(e.options||{},{method:e.verb});s.fetch(e.requestAbsoluteUrl,a).then(function(t){return e.parser.parse(t)}).then(function(t){return i(e,t)}).then(function(e){return n(e)}).catch(function(e){return o(e)})}})},e.logEnd=function(e){return new Promise(function(t){e.isBatched?r.Logger.log({data:1===r.Logger.activeLogLevel?{}:e,level:1,message:"["+e.requestId+"] ("+(new Date).getTime()+") "+e.verb+" request will complete in batch "+e.batch.batchId+"."}):r.Logger.log({data:1===r.Logger.activeLogLevel?{}:e,level:1,message:"["+e.requestId+"] ("+(new Date).getTime()+") Completing "+e.verb+" request."}),t(e)})},Object.defineProperty(e,"default",{get:function(){return[e.logStart,e.caching,e.send,e.logEnd]},enumerable:!0,configurable:!0}),n.__decorate([a(!0)],e,"logStart",null),n.__decorate([a()],e,"caching",null),n.__decorate([a()],e,"send",null),n.__decorate([a(!0)],e,"logEnd",null),e}(),P=function(e){function t(t){void 0===t&&(t="This query is already part of a batch.");var n=e.call(this,t)||this;return n.name="AlreadyInBatchException",r.Logger.log({data:{},level:3,message:"["+n.name+"]::"+n.message}),n}return n.__extends(t,e),t}(Error),q=function(){function e(){this._batch=null,this._query=new t.Dictionary,this._options={},this._url="",this._parentUrl="",this._useCaching=!1,this._cachingOptions=null}return e.prototype.concat=function(e){return this._url+=e,this},Object.defineProperty(e.prototype,"query",{get:function(){return this._query},enumerable:!0,configurable:!0}),e.prototype.configure=function(e){return t.mergeOptions(this._options,e),this},e.prototype.usingCaching=function(e){return t.RuntimeConfig.globalCacheDisable||(this._useCaching=!0,void 0!==e&&(this._cachingOptions=e)),this},e.prototype.inBatch=function(e){if(null!==this.batch)throw new P;return this._batch=e,this},e.prototype.toUrl=function(){return this._url},e.prototype.get=function(e,t){return void 0===e&&(e=new f),void 0===t&&(t={}),this.toRequestContext("GET",t,e,w.default).then(function(e){return s(e)})},e.prototype.getAs=function(e,t){return void 0===e&&(e=new f),void 0===t&&(t={}),this.toRequestContext("GET",t,e,w.default).then(function(e){return s(e)})},e.prototype.postCore=function(e,t){return void 0===e&&(e={}),void 0===t&&(t=new f),this.toRequestContext("POST",e,t,w.default).then(function(e){return s(e)})},e.prototype.postAsCore=function(e,t){return void 0===e&&(e={}),void 0===t&&(t=new f),this.toRequestContext("POST",e,t,w.default).then(function(e){return s(e)})},e.prototype.patchCore=function(e,t){return void 0===e&&(e={}),void 0===t&&(t=new f),this.toRequestContext("PATCH",e,t,w.default).then(function(e){return s(e)})},e.prototype.deleteCore=function(e,t){return void 0===e&&(e={}),void 0===t&&(t=new f),this.toRequestContext("DELETE",e,t,w.default).then(function(e){return s(e)})},e.prototype.addBatchDependency=function(){return null!==this._batch?this._batch.addDependency():function(){return null}},Object.defineProperty(e.prototype,"hasBatch",{get:function(){return t.Util.objectDefinedNotNull(this._batch)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"batch",{get:function(){return this.hasBatch?this._batch:null},enumerable:!0,configurable:!0}),e.prototype.append=function(e){this._url=t.Util.combinePaths(this._url,e)},Object.defineProperty(e.prototype,"parentUrl",{get:function(){return this._parentUrl},enumerable:!0,configurable:!0}),e}(),O=function(){function e(e){void 0===e&&(e=t.Util.getGUID()),this._batchId=e,this._requests=[],this._dependencies=[]}return Object.defineProperty(e.prototype,"batchId",{get:function(){return this._batchId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"requests",{get:function(){return this._requests},enumerable:!0,configurable:!0}),e.prototype.add=function(e,t,n,r){var o={method:t.toUpperCase(),options:n,parser:r,reject:null,resolve:null,url:e},i=new Promise(function(e,t){o.resolve=e,o.reject=t});return this._requests.push(o),i},e.prototype.addDependency=function(){var e=function(){},t=new Promise(function(t){e=t});return this._dependencies.push(t),e},e.prototype.execute=function(){var e=this;return Promise.all(this._dependencies).then(function(){return Promise.all(e._dependencies)}).then(function(){return e.executeImpl()})},e}();e.CachingOptions=c,e.CachingParserWrapper=l,e.ProcessHttpClientResponseException=p,e.ODataParserBase=h,e.ODataDefaultParser=f,e.ODataValue=function(){return new d},e.ODataRawParserImpl=g,e.ODataRaw=y,e.TextFileParser=b,e.BlobFileParser=m,e.JSONFileParser=v,e.BufferFileParser=_,e.setResult=i,e.pipe=s,e.requestPipelineMethod=a,e.PipelineMethods=w,e.AlreadyInBatchException=P,e.ODataQueryable=q,e.ODataBatch=O,Object.defineProperty(e,"__esModule",{value:!0})});