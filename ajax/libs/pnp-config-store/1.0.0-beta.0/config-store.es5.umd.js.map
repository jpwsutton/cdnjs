{"version":3,"file":"config-store.es5.umd.js","sources":["../../../../packages/config-store/src/configuration.ts","../../../../packages/config-store/src/exceptions.ts","../../../../packages/config-store/src/providers/cachingConfigurationProvider.ts","../../../../packages/config-store/src/providers/spListConfigurationProvider.ts"],"sourcesContent":["import { TypedHash, Dictionary } from \"@pnp/common\";\r\n\r\n/**\r\n * Interface for configuration providers\r\n *\r\n */\r\nexport interface IConfigurationProvider {\r\n\r\n    /**\r\n     * Gets the configuration from the provider\r\n     */\r\n    getConfiguration(): Promise<TypedHash<string>>;\r\n}\r\n\r\n/**\r\n * Class used to manage the current application settings\r\n *\r\n */\r\nexport class Settings {\r\n\r\n    /**\r\n     * The settings currently stored in this instance\r\n     */\r\n    private _settings: Dictionary<string>;\r\n\r\n    /**\r\n     * Creates a new instance of the settings class\r\n     *\r\n     * @constructor\r\n     */\r\n    constructor() {\r\n        this._settings = new Dictionary<string>();\r\n    }\r\n\r\n    /**\r\n     * Adds a new single setting, or overwrites a previous setting with the same key\r\n     *\r\n     * @param {string} key The key used to store this setting\r\n     * @param {string} value The setting value to store\r\n     */\r\n    public add(key: string, value: string) {\r\n        this._settings.add(key, value);\r\n    }\r\n\r\n    /**\r\n     * Adds a JSON value to the collection as a string, you must use getJSON to rehydrate the object when read\r\n     *\r\n     * @param {string} key The key used to store this setting\r\n     * @param {any} value The setting value to store\r\n     */\r\n    public addJSON(key: string, value: any) {\r\n        this._settings.add(key, JSON.stringify(value));\r\n    }\r\n\r\n    /**\r\n     * Applies the supplied hash to the setting collection overwriting any existing value, or created new values\r\n     *\r\n     * @param {TypedHash<any>} hash The set of values to add\r\n     */\r\n    public apply(hash: TypedHash<any>): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            try {\r\n                this._settings.merge(hash);\r\n                resolve();\r\n            } catch (e) {\r\n                reject(e);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Loads configuration settings into the collection from the supplied provider and returns a Promise\r\n     *\r\n     * @param {IConfigurationProvider} provider The provider from which we will load the settings\r\n     */\r\n    public load(provider: IConfigurationProvider): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            provider.getConfiguration().then((value) => {\r\n                this._settings.merge(value);\r\n                resolve();\r\n            }).catch((reason) => {\r\n                reject(reason);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Gets a value from the configuration\r\n     *\r\n     * @param {string} key The key whose value we want to return. Returns null if the key does not exist\r\n     * @return {string} string value from the configuration\r\n     */\r\n    public get(key: string): string | null {\r\n        return this._settings.get(key);\r\n    }\r\n\r\n    /**\r\n     * Gets a JSON value, rehydrating the stored string to the original object\r\n     *\r\n     * @param {string} key The key whose value we want to return. Returns null if the key does not exist\r\n     * @return {any} object from the configuration\r\n     */\r\n    public getJSON(key: string): any {\r\n        const o = this.get(key);\r\n        if (typeof o === \"undefined\" || o === null) {\r\n            return o;\r\n        }\r\n\r\n        return JSON.parse(o);\r\n    }\r\n}\r\n","import { Logger, LogLevel } from \"@pnp/logging\";\r\n\r\nexport class NoCacheAvailableException extends Error {\r\n\r\n    constructor(msg = \"Cannot create a caching configuration provider since cache is not available.\") {\r\n        super(msg);\r\n        this.name = \"NoCacheAvailableException\";\r\n        Logger.log({ data: {}, level: LogLevel.Error, message: `[${this.name}]::${this.message}` });\r\n    }\r\n}\r\n","import { IConfigurationProvider } from \"../configuration\";\r\nimport { TypedHash, PnPClientStore, PnPClientStorage } from \"@pnp/common\";\r\nimport { NoCacheAvailableException } from \"../exceptions\";\r\n\r\n/**\r\n * A caching provider which can wrap other non-caching providers\r\n *\r\n */\r\nexport default class CachingConfigurationProvider implements IConfigurationProvider {\r\n    private wrappedProvider: IConfigurationProvider;\r\n    private store: PnPClientStore;\r\n    private cacheKey: string;\r\n\r\n    /**\r\n     * Creates a new caching configuration provider\r\n     * @constructor\r\n     * @param {IConfigurationProvider} wrappedProvider Provider which will be used to fetch the configuration\r\n     * @param {string} cacheKey Key that will be used to store cached items to the cache\r\n     * @param {IPnPClientStore} cacheStore OPTIONAL storage, which will be used to store cached settings.\r\n     */\r\n    constructor(wrappedProvider: IConfigurationProvider, cacheKey: string, cacheStore?: PnPClientStore) {\r\n        this.wrappedProvider = wrappedProvider;\r\n        this.store = (cacheStore) ? cacheStore : this.selectPnPCache();\r\n        this.cacheKey = `_configcache_${cacheKey}`;\r\n    }\r\n\r\n    /**\r\n     * Gets the wrapped configuration providers\r\n     *\r\n     * @return {IConfigurationProvider} Wrapped configuration provider\r\n     */\r\n    public getWrappedProvider(): IConfigurationProvider {\r\n        return this.wrappedProvider;\r\n    }\r\n\r\n    /**\r\n     * Loads the configuration values either from the cache or from the wrapped provider\r\n     *\r\n     * @return {Promise<TypedHash<string>>} Promise of loaded configuration values\r\n     */\r\n    public getConfiguration(): Promise<TypedHash<string>> {\r\n        // Cache not available, pass control to  the wrapped provider\r\n        if ((!this.store) || (!this.store.enabled)) {\r\n            return this.wrappedProvider.getConfiguration();\r\n        }\r\n\r\n        // Value is found in cache, return it directly\r\n        const cachedConfig = this.store.get(this.cacheKey);\r\n        if (cachedConfig) {\r\n            return new Promise<TypedHash<string>>((resolve) => {\r\n                resolve(cachedConfig);\r\n            });\r\n        }\r\n\r\n        // Get and cache value from the wrapped provider\r\n        const providerPromise = this.wrappedProvider.getConfiguration();\r\n        providerPromise.then((providedConfig) => {\r\n            this.store.put(this.cacheKey, providedConfig);\r\n        });\r\n        return providerPromise;\r\n    }\r\n\r\n    private selectPnPCache(): PnPClientStore {\r\n        const pnpCache = new PnPClientStorage();\r\n        if ((pnpCache.local) && (pnpCache.local.enabled)) {\r\n            return pnpCache.local;\r\n        }\r\n        if ((pnpCache.session) && (pnpCache.session.enabled)) {\r\n            return pnpCache.session;\r\n        }\r\n        throw new NoCacheAvailableException();\r\n    }\r\n}\r\n","import { IConfigurationProvider } from \"../configuration\";\r\nimport { TypedHash } from \"@pnp/common\";\r\nimport { default as CachingConfigurationProvider } from \"./cachingConfigurationProvider\";\r\nimport { Web } from \"@pnp/sp\";\r\n\r\n/**\r\n * A configuration provider which loads configuration values from a SharePoint list\r\n *\r\n */\r\nexport default class SPListConfigurationProvider implements IConfigurationProvider {\r\n    /**\r\n     * Creates a new SharePoint list based configuration provider\r\n     * @constructor\r\n     * @param {string} webUrl Url of the SharePoint site, where the configuration list is located\r\n     * @param {string} listTitle Title of the SharePoint list, which contains the configuration settings (optional, default = \"config\")\r\n     */\r\n    constructor(private sourceWeb: Web, private sourceListTitle = \"config\") {\r\n    }\r\n\r\n    /**\r\n     * Gets the url of the SharePoint site, where the configuration list is located\r\n     *\r\n     * @return {string} Url address of the site\r\n     */\r\n    public get web(): Web {\r\n        return this.sourceWeb;\r\n    }\r\n\r\n    /**\r\n     * Gets the title of the SharePoint list, which contains the configuration settings\r\n     *\r\n     * @return {string} List title\r\n     */\r\n    public get listTitle(): string {\r\n        return this.sourceListTitle;\r\n    }\r\n\r\n    /**\r\n     * Loads the configuration values from the SharePoint list\r\n     *\r\n     * @return {Promise<TypedHash<string>>} Promise of loaded configuration values\r\n     */\r\n    public getConfiguration(): Promise<TypedHash<string>> {\r\n\r\n        return this.web.lists.getByTitle(this.listTitle).items.select(\"Title\", \"Value\")\r\n            .getAs<{ Title: string, Value: string }[]>().then((data) => {\r\n                return data.reduce((configuration, item) => {\r\n\r\n                    return Object.defineProperty(configuration, item.Title, {\r\n                        configurable: false,\r\n                        enumerable: false,\r\n                        value: item.Value,\r\n                        writable: false,\r\n                    });\r\n\r\n                }, {});\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Wraps the current provider in a cache enabled provider\r\n     *\r\n     * @return {CachingConfigurationProvider} Caching providers which wraps the current provider\r\n     */\r\n    public asCaching(): CachingConfigurationProvider {\r\n        const cacheKey = `splist_${this.web.toUrl()}+${this.listTitle}`;\r\n        return new CachingConfigurationProvider(this, cacheKey);\r\n    }\r\n}\r\n"],"names":["Dictionary","Logger","LogLevel","PnPClientStorage"],"mappings":"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"}